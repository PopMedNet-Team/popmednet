module Plugins.Requests.QueryBuilder.MDQ {
    export class Terms {
        public static get DataCheckerQueryTypeID(): any {
            return '1F065B02-5BF3-4340-A412-84465C9B164C';
        }
        public static get AgeRangeID(): any {
            return 'D9DD6E82-BBCA-466A-8022-B54FF3D99A3C';
        }
        public static get DrugClassID(): any {
            return '75290001-0E78-490C-9635-A3CA01550704';
        }
        public static get DrugNameID(): any {
            return '0E1F0001-CA0C-42D2-A9CC-A3CA01550E84';
        }
        public static get HCPCSProcedureCodesID(): any {
            return '096A0001-73B4-405D-B45F-A3CA014C6E7D';
        }
        public static get ICD9Diagnosis3digitID(): any {
            return '5E5020DC-C0E4-487F-ADF2-45431C2B7695';
        }
        public static get ICD9Diagnosis4digitID(): any {
            return 'D0800001-2810-48ED-96B9-A3D40146BAAE';
        }
        public static get ICD9Diagnosis5digitID(): any {
            return '80750001-6C3B-4C2D-90EC-A3D40146C26D';
        }
        public static get ICD9Procedure3digitID(): any {
            return 'E1CC0001-1D9A-442A-94C4-A3CA014C7B94';
        }
        public static get ICD9Procedure4digitID(): any {
            return '9E870001-1D48-4AA3-8889-A3D40146CCB3';
        }
        public static get ZipCodeID(): any {
            return '8B5FAA77-4A4B-4AC7-B817-69F1297E24C5';
        }
        public static get CombinedDiagnosisCodesID(): any {
            return '86110001-4BAB-4183-B0EA-A4BC0125A6A7';
        }
        public static get ESPCombinedDiagnosisCodesID(): any {
            return 'A21E9775-39A4-4ECC-848B-1DC881E13689';
        }
        public static get MetadataRefreshID(): any {
            return '421BAC16-CAAC-4918-8760-A10FF76CC87B';
        }
        public static get ConditionID(): any {
            return 'EC593176-D0BF-4E5A-BCFF-4BBD13E88DBF';
        }
        public static get TrialID(): any {
            return '56A38F6D-993A-4953-BCB9-11BDD809C0B4';
        }
        public static get PatientReportedOutcomeID(): any {
            return 'AE87C785-BB74-4708-B0CD-FA91D584615C';
        }
        public static get PatientReportedOutcomeEncounterID(): any {
            return 'A11DCC97-4C8D-4B80-AE61-58ECB2F66C3D';
        }
        public static get VisitsID(): any {
            return 'F01BE0A4-7D8E-4288-AE33-C65166AF8335';
        }
        public static get SexID(): any {
            return '71B4545C-345B-48B2-AF5E-F84DC18E4E1A';
        }
        public static get CodeMetricID(): any {
            return 'E39D0001-07A1-4DFD-9299-A3CB00F2474B';
        }
        public static get CoverageID(): any {
            return 'DC880001-23B2-4F36-94E2-A3CB00DA8248';
        }
        public static get CriteriaID(): any {
            return '17540001-8185-41BB-BE64-A3CB00F27EC2';
        }
        public static get DispensingMetricID(): any {
            return '16ED0001-7E2D-4B27-B943-A3CB0162C262';
        }
        public static get EthnicityID(): any {
            return '702CE918-9A59-4082-A8C7-A9234536FE79';
        }
        public static get FacilityID(): any {
            return 'A257DA68-9557-4D6A-AEBD-541AA9BDD145';
        }
        public static get HeightID(): any {
            return '8BC627CA-5729-4E7A-9702-0000A45A0018';
        }
        public static get HispanicID(): any {
            return 'D26FE166-49A2-47F8-87E2-4F42A945D4D5';
        }
        public static get ObservationPeriodID(): any {
            return '98A78326-35D2-461A-B858-5B69E0FED28A';
        }
        public static get QuarterYearID(): any {
            return 'D62F0001-3FE1-4910-99A9-A3CB014C2BC7';
        }
        public static get RaceID(): any {
            return '834F0001-FA03-4ECD-BE28-A3CD00EC02E2';
        }
        public static get SettingID(): any {
            return '2DE50001-7882-4EDE-AC4F-A3CB00D9051A';
        }
        public static get TobaccoUseID(): any {
            return '342C354B-9ECC-479B-BE61-1770E4B44675';
        }
        public static get WeightID(): any {
            return '3B0ED310-DDE9-4836-9857-0000A45A0018';
        }
        public static get YearID(): any {
            return '781A0001-1FF0-41AB-9E67-A3CB014C37F2';
        }
        public static get VitalsMeasureDateID(): any {
            return 'F9920001-AEB1-425C-A929-A4BB01515850';
        }
        public static get ProcedureCodesID(): any {
            return 'F81AE5DE-7B35-4D7A-B398-A72200CE7419';
        }
        public static get LOINCCodesID(): any {
            return 'F5903376-D2A5-486F-92D3-1F97D598A221';
        }
        public static get PrescribingCodesID(): any {
            return '793BD948-C90C-45DA-B4B7-F8E2387E1A78';
        }
        public static get FileUploadID(): any {
            return '2F60504D-9B2F-4DB1-A961-6390117D3CAC';
        }
        public static get ModularProgramID(): any {
            return 'A1AE0001-E5B4-46D2-9FAD-A3D8014FFFD8';
        }
        public static get ClinicalObservationsID(): any {
            return '7A51AB7A-AEC5-4A4B-A073-FBFF754EA478';
        }
        public static get DC_DiagnosisCodes(): any {
            return 'E1DA9C98-3F95-4F6E-AEDF-B42E2881DB73';
        }
        public static get DC_ProcedureCodes(): any {
            return '1CC38753-CD3F-4696-AF5F-9818EABF8AD0';
        }
        public static get DC_NDCCodes(): any {
            return '02A7FD90-AAD2-4986-9C5D-1D22E27AB960';
        }


        public static Compare(a: any, b: any): boolean {
            if ((a == null && b != null) || (a != null && b == null))
                return false;

            if (a == null && b == null)
                return true;

            return a.toLowerCase() === b.toLowerCase();
        }

        /** Grouped terms are to be combined using OR within a sub-criteria that will be AND'd with the other terms of the parent criteria. */
        static GroupedTerms: any[] = [
            //Condition
            Terms.ConditionID,
            //HCPCS Procedure Codes
            Terms.HCPCSProcedureCodesID,
            //Combined Diagnosis Codes
            Terms.CombinedDiagnosisCodesID,
            //ICD9 Diagnosis Codes 3 digit
            Terms.ICD9Diagnosis3digitID,
            //ICD9 Diagnosis Codes 4 digit
            Terms.ICD9Diagnosis4digitID,
            //ICD9 Diagnosis Codes 5 digit
            Terms.ICD9Diagnosis5digitID,
            //ICD9 Procedure Codes 3 digit
            Terms.ICD9Procedure3digitID,
            //ICD9 Procedure Codes 4 digit
            Terms.ICD9Procedure4digitID,
            //ESP Combined Diagnosis Codes
            Terms.ESPCombinedDiagnosisCodesID,
            //Drug Class
            Terms.DrugClassID,
            //Drug Name
            Terms.DrugNameID,
            //Visits
            Terms.VisitsID,
            //Age Range
            Terms.AgeRangeID,
            //Sex
            Terms.SexID,
            //Code Metric
            Terms.CodeMetricID,
            //Coverage
            Terms.CoverageID,
            //Criteria
            Terms.CriteriaID,
            //Dispensing Metric
            Terms.DispensingMetricID,
            //Ethnicity
            Terms.EthnicityID,
            //Facility
            Terms.FacilityID,
            //Height
            Terms.HeightID,
            //Hispanic
            Terms.HispanicID,
            //Observation Period
            Terms.ObservationPeriodID,
            //Quarter Year
            Terms.QuarterYearID,
            //Race
            Terms.RaceID,
            //Setting
            Terms.SettingID,
            //Tobacco Use
            Terms.TobaccoUseID,
            //Weight
            Terms.WeightID,
            //Year
            Terms.YearID,
            //Zip Code
            Terms.ZipCodeID,
            //Vitals Measure Date
            Terms.VitalsMeasureDateID,
            // Procedure Codes
            Terms.ProcedureCodesID,
            //TrialID
            Terms.TrialID,
            //PatientReportedOutcome
            Terms.PatientReportedOutcomeID,
            // LOINC Codes
            Terms.LOINCCodesID,
            //Prescribing Terms
            Terms.PrescribingCodesID,
            //Clinical Observations
            Terms.ClinicalObservationsID,
            Terms.DC_DiagnosisCodes,
            Terms.DC_ProcedureCodes,
            Terms.DC_NDCCodes
        ];

        /** Non-code terms that still need to use a sub-criteria to handle multiple term's OR'd together */
        static NonCodeGroupedTerms: any[] = [
            //Visits
            Terms.VisitsID,
            //Age Range
            Terms.AgeRangeID,
            //Sex
            Terms.SexID,
            //Code Metric
            Terms.CodeMetricID,
            //Coverage
            Terms.CoverageID,
            //Criteria
            Terms.CriteriaID,
            //Dispensing Metric
            Terms.DispensingMetricID,
            //Ethnicity
            Terms.EthnicityID,
            //Facility
            Terms.FacilityID,
            //Height
            Terms.HeightID,
            //Hispanic
            Terms.HispanicID,
            //Observation Period
            Terms.ObservationPeriodID,
            //Quarter Year
            Terms.QuarterYearID,
            //Race
            Terms.RaceID,
            //Setting
            Terms.SettingID,
            //Tobacco Use
            Terms.TobaccoUseID,
            //Weight
            Terms.WeightID,
            //Year
            Terms.YearID,
            //Zip Code
            Terms.ZipCodeID,
            //Vitals Measure Date
            Terms.VitalsMeasureDateID,
            //TrialID
            Terms.TrialID,
            //PatientReportedOutcome
            Terms.PatientReportedOutcomeID
        ];

        /** DataChecker Procedure Code Types */
        static DataCheckerProcedureCodeTypes: Dns.Structures.KeyValuePair[] = [
            { text: 'Any', value: '' },
            { text: 'ICD-9-CM', value: '09' },
            { text: 'ICD-10-CM', value: '10' },
            { text: 'ICD-11-CM', value: '11' },
            { text: 'CPT Category II', value: 'C2' },
            { text: 'CPT Category III', value: 'C3' },
            { text: 'CPT-4 (i.e., HCPCS Level I)', value: 'C4' },
            { text: 'HCPCS (i.e., HCPCS Level II)', value: 'HC' },
            { text: 'HCPCS Level III', value: 'H3' },
            { text: 'LOINC', value: 'LC' },
            { text: 'Local Homegrown', value: 'LO' },
            { text: 'NDC', value: 'ND' },
            { text: 'Revenue', value: 'RE' },
            { text: 'Other', value: 'OT' }];

        /** DataChecker Diagnosis Code Types */
        static DataCheckerDiagnosisCodeTypes: Dns.Structures.KeyValuePair[] =[
            { text: 'Any', value: '' },
            { text: 'ICD-9-CM', value: '09' },
            { text: 'ICD-10-CM', value: '10' },
            { text: 'ICD-11-CM', value: '11' },
            { text: 'SNOMED CT', value: 'SM' },
            { text: 'Other', value: 'OT' }];
    }

    export class TermValueFilter {       

        public static get PCORnetModelID(): any {
            return '85ee982e-f017-4bc4-9acd-ee6ee55d2446';
        }
        public static get SummaryTablesModelID(): any {
            return 'cc14e6a2-99a8-4ef8-b4cb-779a7b93a7bb';
        }
        public static get ESPModelID(): any {
            return '7c69584a-5602-4fc0-9f3f-a27f329b1113';
        }
        public static get DataCheckerModelID(): any {
            return '321adaa1-a350-4dd0-93de-5de658a507df';
        }
        public static get ModularProgramModelID(): any {
            return '1b0ffd4c-3eef-479d-a5c4-69d8ba0d0154';
        }
        public static get DistributedRegressionModelID(): any {
            return '4c8a25dc-6816-4202-88f4-6d17e72a43bc';
        }
        public static get FileDistributionModelID(): any {
            return '00bf515f-6539-405b-a617-ca9f8aa12970';
        }

        public static ContainsModel(models: any[], id: any): boolean {
            for (let i = 0; i < models.length; i++) {
                if (Constants.Guid.compare(models[i], id) == 0)
                    return true;
            }

            return false;
        }

        public static QueryContainsTerm(query: Dns.Interfaces.IQueryComposerQueryDTO, termID: any): boolean {
            if (query == null || termID == null)
                return false;

            for (let i = 0; i < query.Where.Criteria.length; i++) {
                let criteria = query.Where.Criteria[i];
                if (this.CriteriaContainsTerm(criteria, termID)) {
                    return true;
                }
            }

            return false;
        }

        public static CriteriaContainsTerm(criteria: Dns.Interfaces.IQueryComposerCriteriaDTO, termID: any): boolean {
            if (criteria == null || termID == null) {
                return false;
            }

            for (let i = 0; i < criteria.Terms.length; i++) {
                let term = criteria.Terms[i];
                if (Terms.Compare(term.Type, termID))
                    return true;                
            }

            if (criteria.Criteria) {
                for (let j = 0; j < criteria.Criteria.length; j++) {
                    if (this.CriteriaContainsTerm(criteria.Criteria[j], termID)) {
                        return true;
                    }
                }
            }

            return false;
        }

        private _models: KnockoutObservableArray<any>;
        private _containsPCORnet: KnockoutComputed<boolean>;
        private _containsSummaryTables: KnockoutComputed<boolean>;
        private _containsESP: KnockoutComputed<boolean>;
        private _containsDataChecker: KnockoutComputed<boolean>;
        private _containsModularProgram: KnockoutComputed<boolean>;

        SexValues: KnockoutComputed<Dns.Structures.KeyValuePair[]>;
        SettingsValues: KnockoutComputed<Dns.Structures.KeyValuePair[]>;
        RaceValues: KnockoutComputed<Dns.Structures.KeyValuePair[]>;
        RaceEthnicityValues: KnockoutComputed<Dns.Structures.KeyValuePair[]>;
        AgeRangeStratifications: KnockoutComputed<Dns.Structures.KeyValuePair[]>;

        constructor(models: any[]) {
            this._models = ko.observableArray<any>(models || []);

            this._containsPCORnet = ko.pureComputed(() => TermValueFilter.ContainsModel(this._models(), TermValueFilter.PCORnetModelID));
            this._containsSummaryTables = ko.pureComputed(() => TermValueFilter.ContainsModel(this._models(), TermValueFilter.SummaryTablesModelID));
            this._containsESP = ko.pureComputed(() => TermValueFilter.ContainsModel(this._models(), TermValueFilter.ESPModelID));
            this._containsDataChecker = ko.pureComputed(() => TermValueFilter.ContainsModel(this._models(), TermValueFilter.DataCheckerModelID));
            this._containsModularProgram = ko.pureComputed(() => TermValueFilter.ContainsModel(this._models(), TermValueFilter.ModularProgramModelID));

            this.SexValues = ko.pureComputed(this.getSexValues.bind(this));
            this.SettingsValues = ko.pureComputed(this.getSettingsValues.bind(this));
            this.RaceValues = ko.pureComputed(this.getRaceValues.bind(this));
            this.RaceEthnicityValues = ko.pureComputed(this.getRaceEthnicityValues.bind(this));
            this.AgeRangeStratifications = ko.pureComputed(this.getAgeRangeStratifications.bind(this));
        }

        static GetTranslations<T>(translations: Dns.Structures.KeyValuePair[], values: T[]): Dns.Structures.KeyValuePair[] {
            let selected: Dns.Structures.KeyValuePair[] = [];
            
            for (let i = 0; i < translations.length; i++) {
                let item = translations[i];
                if (values.indexOf(item.value) >= 0) {
                    selected.push(item);
                }
                if (selected.length == values.length)
                    break;
            }

            return selected;
        }

        public UpdateModels(models: any[]) {
            this._models(models || []);
        }

        /*Indicates if the models set for the helper contain the specified model.*/
        public HasModel(modelID: any): boolean {
            return TermValueFilter.ContainsModel(this._models(), modelID);
        }

        /* Returns the valid values based on the models specified in initiation */
        private getSexValues(): Dns.Structures.KeyValuePair[] {
            let sexTranslations = [];
            //Dont include MaleAndFemaleAggregated in the list of Sex Values
            Dns.Enums.SexStratificationsTranslation.forEach((s) => {
                if (s.value != Dns.Enums.SexStratifications.MaleAndFemaleAggregated)
                    sexTranslations.push(s);
            });

            if (this._models().length == 0)
                return sexTranslations;

            if (this._containsSummaryTables() == true)
                return TermValueFilter.GetTranslations<Dns.Enums.SexStratifications>(Dns.Enums.SexStratificationsTranslation, [Dns.Enums.SexStratifications.FemaleOnly, Dns.Enums.SexStratifications.MaleOnly, Dns.Enums.SexStratifications.MaleAndFemale, Dns.Enums.SexStratifications.MaleAndFemaleAggregated, Dns.Enums.SexStratifications.Unknown]);

            if (this._containsPCORnet() == false) {
                //models collection does not contain PCORnet, return subset of values. They are the same for Summary Tables and ESP
                return TermValueFilter.GetTranslations<Dns.Enums.SexStratifications>(Dns.Enums.SexStratificationsTranslation, [Dns.Enums.SexStratifications.FemaleOnly, Dns.Enums.SexStratifications.MaleOnly, Dns.Enums.SexStratifications.MaleAndFemale]);
            }

            return sexTranslations;
        }



        /* Returns the valid values based on the models specified in initiation */
        private getSettingsValues(): Dns.Structures.KeyValuePair[] {
            if (this._models().length == 0)
                return Dns.Enums.SettingsTranslation;

            let translations = [];
            if (this._containsSummaryTables() && this._containsPCORnet()) {
                TermValueFilter.GetTranslations<Dns.Enums.Settings>(Dns.Enums.SettingsTranslation, [Dns.Enums.Settings.IP, Dns.Enums.Settings.AV, Dns.Enums.Settings.ED, Dns.Enums.Settings.AN, Dns.Enums.Settings.EI, Dns.Enums.Settings.IS, Dns.Enums.Settings.OS, Dns.Enums.Settings.IC, Dns.Enums.Settings.OA, Dns.Enums.Settings.NI, Dns.Enums.Settings.UN, Dns.Enums.Settings.OT]).forEach((i) => translations.push(i));
            }

            if (this._containsSummaryTables()) {
                TermValueFilter.GetTranslations<Dns.Enums.Settings>(Dns.Enums.SettingsTranslation, [Dns.Enums.Settings.IP, Dns.Enums.Settings.AV, Dns.Enums.Settings.ED, Dns.Enums.Settings.AN]).forEach((i) => translations.push(i));
            }

            if (this._containsPCORnet()) {
                TermValueFilter.GetTranslations<Dns.Enums.Settings>(Dns.Enums.SettingsTranslation, [Dns.Enums.Settings.IP, Dns.Enums.Settings.AV, Dns.Enums.Settings.ED, Dns.Enums.Settings.EI, Dns.Enums.Settings.IS, Dns.Enums.Settings.OS, Dns.Enums.Settings.IC, Dns.Enums.Settings.OA, Dns.Enums.Settings.NI, Dns.Enums.Settings.UN, Dns.Enums.Settings.OT]).forEach((i) => translations.push(i));
            }

            return translations;
        }

        /* Returns the valid values based on the models specified in initiation */
        private getRaceValues(): Dns.Structures.KeyValuePair[] {
            if (this._models().length == 0 || this._containsPCORnet())
                return Dns.Enums.RaceTranslation;

            if (this._containsSummaryTables()) {
                return TermValueFilter.GetTranslations<Dns.Enums.Race>(Dns.Enums.RaceTranslation, [Dns.Enums.Race.Native, Dns.Enums.Race.Asian, Dns.Enums.Race.Black, Dns.Enums.Race.Pacific, Dns.Enums.Race.White, Dns.Enums.Race.Unknown]);
            }

            return [];           
        }

        /* Returns the valid values based on the models specified in initiation */
        private getRaceEthnicityValues(): Dns.Structures.KeyValuePair[] {
            if (this._models().length == 0)
                return Dns.Enums.EthnicitiesTranslation;

            if (this._containsESP()) {
                return TermValueFilter.GetTranslations<Dns.Enums.Ethnicities>(Dns.Enums.EthnicitiesTranslation, [Dns.Enums.Ethnicities.Unknown, Dns.Enums.Ethnicities.Native, Dns.Enums.Ethnicities.Asian, Dns.Enums.Ethnicities.Black, Dns.Enums.Ethnicities.White, Dns.Enums.Ethnicities.Hispanic]);
            }

            return [];
        }

        /* Returns the valid values based on the models specified in initiation */
        private getAgeRangeStratifications(): Dns.Structures.KeyValuePair[] {
            
            if (this._models().length == 0)
                return Dns.Enums.AgeStratificationsTranslation;

            let translations = [];
            if (this._containsSummaryTables()) {
                TermValueFilter.GetTranslations<Dns.Enums.AgeStratifications>(Dns.Enums.AgeStratificationsTranslation, [Dns.Enums.AgeStratifications.Ten, Dns.Enums.AgeStratifications.Seven, Dns.Enums.AgeStratifications.Four, Dns.Enums.AgeStratifications.Two, Dns.Enums.AgeStratifications.None]).forEach((i) => translations.push(i));
            }

            if (this._containsESP() || this._containsPCORnet()) {
                TermValueFilter.GetTranslations<Dns.Enums.AgeStratifications>(Dns.Enums.AgeStratificationsTranslation, [Dns.Enums.AgeStratifications.FiveYearGrouping, Dns.Enums.AgeStratifications.TenYearGrouping]).forEach((i) => translations.push(i));
            }
            
            if (this._containsPCORnet()) {
                TermValueFilter.GetTranslations<Dns.Enums.AgeStratifications>(Dns.Enums.AgeStratificationsTranslation, [Dns.Enums.AgeStratifications.None]).forEach((i) => translations.push(i));
            }

            return translations;
        }

        /* Confirm all properties exist that have been addd to a template that may not exist on the request json*/
        public ConfirmTemplateProperties(query: Dns.Interfaces.IQueryComposerQueryDTO, termTemplates: IVisualTerm[]) {
            let flattenedTerms = this.FlattenTermTemplates(termTemplates, []);
            //loop through all the terms on all the criteria and make sure each term is up to date
            for (let i = 0; i < query.Where.Criteria.length; i++) {
                let criteria = query.Where.Criteria[i];
                this.ConfirmCriteria(criteria, flattenedTerms);

                if (criteria.Terms && criteria.Terms.length > 0) {
                    for (let j = 0; j < criteria.Terms.length; j++) {
                        let term = criteria.Terms[j];
                        let termTemplate = ko.utils.arrayFirst(flattenedTerms, (template: IVisualTerm) => { return template.TermID == term.Type; });
                        if (termTemplate) {
                            this.ConfirmTermValues(term, termTemplate);
                        }
                    }
                }

            }
        }

        public ConfirmTemplatePropertiesForViewModel(query: Dns.ViewModels.QueryComposerQueryViewModel, termTemplates: IVisualTerm[]) {
            
            let flattenedTerms = this.FlattenTermTemplates(termTemplates, []) as IVisualTerm[];
            //loop through all the terms on all the criteria and make sure each term is up to date
            
            let rootCriteria = query.Where.Criteria();

            for (let i = 0; i < rootCriteria.length; i++) {
                let criteria: Dns.ViewModels.QueryComposerCriteriaViewModel = rootCriteria[i];
                this.ConfirmCriteriaForViewModel(criteria, flattenedTerms);
            }

            //check the criteria for each temporal event
            let temporalEvents = query.TemporalEvents();
            for (let i = 0; i < temporalEvents.length; i++) {
                let temporalEvent = temporalEvents[i];
                let rootCriteria = temporalEvent.Criteria();
                for (let j = 0; j < rootCriteria.length; j++) {
                    let criteria: Dns.ViewModels.QueryComposerCriteriaViewModel = rootCriteria[j];
                    this.ConfirmCriteriaForViewModel(criteria, flattenedTerms);

                    if (criteria.Terms() && criteria.Terms().length > 0) {
                        for (let k = 0; k < criteria.Terms().length; k++) {
                            let term = criteria.Terms()[k];
                            let termTemplate = ko.utils.arrayFirst(flattenedTerms, (template: IVisualTerm) => { return template.TermID == term.Type(); });
                            if (termTemplate) {
                                this.ConfirmTermValuesForViewModel(term, termTemplate);
                            }
                        }
                    }

                }
            }
            
        }

        private FlattenTermTemplates(termTemplates: IVisualTerm[], flattened: IVisualTerm[]) {
            for (let i = 0; i < termTemplates.length; i++) {

                if (termTemplates[i].TermID) {
                    flattened.push(termTemplates[i]);
                }

                if (termTemplates[i].Terms) {
                    flattened = this.FlattenTermTemplates(termTemplates[i].Terms, flattened);
                }
            }
            return flattened;
        }

        private ConfirmCriteria(criteria: Dns.Interfaces.IQueryComposerCriteriaDTO, termTemplates: IVisualTerm[]) {
            if (criteria.Terms) {
                let term;
                let termTemplate;
                for (let i = 0; i < criteria.Terms.length; i++) {
                    term = criteria.Terms[i];
                    termTemplate = ko.utils.arrayFirst(termTemplates, (template: IVisualTerm) => { return template.TermID == term.Type; });
                    if (termTemplate) {
                        this.ConfirmTermValues(term, termTemplate);
                    }
                }
            }

            if (criteria.Criteria && criteria.Criteria.length > 0) {
                for (let  j = 0; j < criteria.Criteria.length; j++) {
                    this.ConfirmCriteria(criteria.Criteria[j], termTemplates);
                }
            }
        }

        public ConfirmCriteriaForViewModel(criteria: Dns.ViewModels.QueryComposerCriteriaViewModel, termTemplates: IVisualTerm[]) {
            let terms = criteria.Terms();
            if (terms) {

                let term: Dns.ViewModels.QueryComposerTermViewModel;
                let termTemplate: IVisualTerm;

                for (let i = 0; i < terms.length; i++) {
                    term = terms[i];

                    termTemplate = ko.utils.arrayFirst(termTemplates, (template: IVisualTerm) => { return template.TermID == term.Type(); });
                    if (termTemplate) {
                        this.ConfirmTermValuesForViewModel(term, termTemplate);
                    }
                }
            }

            let subCriteria = criteria.Criteria();
            if (subCriteria && subCriteria.length > 0) {
                for (let j = 0; j < subCriteria.length; j++) {
                    this.ConfirmCriteriaForViewModel(subCriteria[j], termTemplates);
                }
            }
        }

        private ConfirmTermValues(term: Dns.Interfaces.IQueryComposerTermDTO, termTemplate: IVisualTerm) {
            let termProperties: string[] = Object.keys(term.Values);
            let tvalProperties: string[] = Object.keys(termTemplate.ValueTemplate);
            let propertyName: string;
            for (let i = 0; i < tvalProperties.length; i++) {
                propertyName = tvalProperties[i];
                if (termProperties.indexOf(propertyName) < 0) {                    
                    term.Values[propertyName] = termTemplate.ValueTemplate[propertyName];
                }
            }

        }

        private ConfirmTermValuesForViewModel(term: Dns.ViewModels.QueryComposerTermViewModel, termTemplate: IVisualTerm) {
            
            let unwrapped = ko.unwrap(term.Values);
            let termProperties: string[] = Object.keys(unwrapped);
            let tvalProperties: string[] = Object.keys(termTemplate.ValueTemplate);
            let propertyName: string;

            for (let i = 0; i < tvalProperties.length; i++) {
                propertyName = tvalProperties[i];
                if (termProperties.indexOf(propertyName) < 0) {
                    unwrapped[propertyName] = termTemplate.ValueTemplate[propertyName];
                }
            }

            //update the instance term values to observables
            let values = Global.Helpers.ConvertTermObject(unwrapped);
            term.Values(values);
        }

    }

}